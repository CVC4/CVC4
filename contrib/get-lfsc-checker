#!/usr/bin/env bash

# utility function to download a file
function download {
  if [ -x "$(command -v wget)" ]; then
    wget -c -O "$2" "$1"
  elif [ -x "$(command -v curl)" ]; then
    curl -L "$1" >"$2"
  else
    echo "Can't figure out how to download from web.  Please install wget or curl." >&2
    exit 1
  fi
}

CVC_DIR=$(dirname $(dirname "$0"))
mkdir -p $CVC_DIR/deps
pushd $CVC_DIR/deps

BASE_DIR=`pwd`
mkdir -p $BASE_DIR/tmp/

##### LFSC
LFSC_DIR="$BASE_DIR/lfsc-checker"
mkdir -p $LFSC_DIR

# download and unpack LFSC
version="15f53d6feb84e4ddb41deaf2b5630f5c1303b06d"
download "https://github.com/CVC4/LFSC/archive/$version.tar.gz" $BASE_DIR/tmp/lfsc.tgz
tar --strip 1 -xzf $BASE_DIR/tmp/lfsc.tgz -C $LFSC_DIR

# build and install LFSC
pushd $LFSC_DIR
mkdir -p build && cd build
cmake -DCMAKE_INSTALL_PREFIX="$BASE_DIR" ..
make install
popd

##### signatures
SIG_DIR="$BASE_DIR/lfsc-signatures"
mkdir -p $SIG_DIR

# download and unpack signatures
sig_version="5d72dafd48aded21fd717ef77321e1c88f732d28"
download "https://github.com/CVC4/signatures/archive/$sig_version.tar.gz" $BASE_DIR/tmp/signatures.tgz
tar --strip 1 -xzf $BASE_DIR/tmp/signatures.tgz -C $SIG_DIR

# install signatures and scripts
mkdir -p $BASE_DIR/share/lfsc
cp -r $SIG_DIR/lfsc/new/signatures $BASE_DIR/share/lfsc

# based on https://github.com/CVC4/signatures/blob/master/lfsc/new/scripts/cvc4_gen_and_check.sh
cat << EOF > $BASE_DIR/bin/cvc4-lfsc-check.sh
#!/bin/bash

echo "=== Generate with CVC4 \$@" 
\$@ --dump-proofs --proof-format=lfsc | tail -n +2 > proof.plf
echo "=== End generate with CVC4" 

$BASE_DIR/bin/lfsc-check.sh proof.plf
EOF
chmod +x $BASE_DIR/bin/cvc4-lfsc-check.sh

# based on https://github.com/CVC4/signatures/blob/master/lfsc/new/scripts/lfsc_check.sh
cat << EOF > $BASE_DIR/bin/lfsc-check.sh
#!/bin/bash

echo "=== Check with lfsc \$@"

cat \$@ | grep WARNING
CHECK=\$(cat \$@ | grep check)
[ -z "\$CHECK" ] && echo "; WARNING: Empty proof!!!"

SIG_DIR=$BASE_DIR/share/lfsc/signatures
SIGS="\$SIG_DIR/core_defs.plf \\
    \$SIG_DIR/util_defs.plf \\
    \$SIG_DIR/theory_def.plf \\
    \$SIG_DIR/type_checking_programs.plf \\
    \$SIG_DIR/nary_programs.plf \\
    \$SIG_DIR/boolean_programs.plf \\
    \$SIG_DIR/boolean_rules.plf \\
    \$SIG_DIR/cnf_rules.plf \\
    \$SIG_DIR/equality_rules.plf \\
    \$SIG_DIR/arith_programs.plf \\
    \$SIG_DIR/arith_rules.plf \\
    \$SIG_DIR/strings_programs.plf \\
    \$SIG_DIR/strings_rules.plf \\
    \$SIG_DIR/quantifiers_rules.plf"
$BASE_DIR/bin/lfscc \$SIGS \$@ >& temp-lfsc.txt

# recover macros for applications of arity 1,2,3, and simplify builtin syntax for constants
#sed -i 's/(f_ite [^ \)]*)/f_ite/g' temp-lfsc.txt
#sed -i 's/(\\ [^ ]* (\\ [^ ]* (\\ [^ ]* (apply (apply (apply f_\([^ ]*\) [^ ]*) [^ ]*) [^ ]*))))/\1/g; s/(\\ [^ ]* (\\ [^ ]* (apply (apply f_\([^ ]*\) [^ ]*) [^ ]*)))/\1/g; s/(\\ [^ ]* (apply f_\([^ ]*\) [^ ]*))/\1/g; s/(var \([^ ]*\) [^ \)]*)/var_\1/g; s/(int \([^ \)]*\))/\1/g; s/emptystr/""/g; s/int\.//g' temp-lfsc.txt

cat temp-lfsc.txt

rm temp-lfsc.txt

echo "=== Finished check with lfsc"
EOF
chmod +x $BASE_DIR/bin/lfsc-check.sh

popd

echo ""
echo "========== How to use LFSC =========="
echo "Check a generated proof:"
echo "  $BASE_DIR/bin/lfsc-check.sh <proof file>"
echo "Run CVC4 and check the generated proof:"
echo "  $BASE_DIR/bin/cvc4-lfsc-check.sh <path to cvc4>/cvc4 <options for cvc4> <input file>"
